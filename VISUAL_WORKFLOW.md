# 📸 Visual Testing Workflow

This document outlines the complete visual testing workflow for the Quillworks project, including snapshot management, branching conventions, and rollback procedures.

## 🗂️ Snapshot Directory Convention

### Structure
```
snapshots/
├── archive/
│   └── YYYY-MM-DD/              # Date-prefixed archives
│       ├── *-snapshots/         # Test snapshot directories
│       └── README.md            # Context documentation
└── active/                      # Current working snapshots
    └── README.md               # Active snapshot reference
```

### Naming Convention
- **Archive directories**: `YYYY-MM-DD` format (e.g., `2025-07-30`)
- **Snapshot files**: Auto-generated by Playwright with platform suffix
- **README files**: Document snapshot context and test results

## 🌳 Branching Strategy

### Branch Types
1. **main**: Protected production branch
   - Only receives squash-merged PRs
   - Represents current production state
   - Protected with required reviews

2. **feature/***: New feature development
   - Branch from latest production tag
   - Example: `feature/mobile-nav`

3. **fix/***: Bug fixes and patches
   - Branch from production tag or main
   - Example: `fix/font-loading`

4. **main-sync**: Special cleanup branch
   - Used to reset main history
   - Always squash-merge to main

### Tag Convention
- **Production**: `prod-visual-lock-YYYY-MM-DD`
- **Baseline**: `visual-baseline-YYYY-MM-DD`
- **Rollback**: `rollback-YYYY-MM-DD`

## 🧪 Visual Testing Process

### 1. Before Making Visual Changes
```bash
# Always backup current snapshots
npm run snapshots        # backup current snapshots

# Verify current state
npm run test:visual:quick
```

### 2. During Development
```bash
# Run quick tests frequently
npm run test:visual:quick      # ~10 seconds

# Run full suite before commits
npm run test:visual:all         # ~2 minutes
```

### 3. Updating Snapshots
```bash
# Only update if changes are intentional
npx playwright test --update-snapshots

# Update specific test suite
npx playwright test tests/visual-integrity.spec.ts --update-snapshots
```

### 4. Archiving Snapshots
On major milestones:
```bash
# Create dated archive
npm run snapshots        # backup current snapshots

# Archive will be created at:
# snapshots/archive/YYYY-MM-DD/
```

## 📊 Test Thresholds

| Category | Threshold | Use Case |
|----------|-----------|----------|
| Ultra-strict | 0.005% | Hero sections, critical UI |
| Very strict | 0.01% | Typography, layout |
| Strict | 0.03% | Icons, general components |

## 🔄 Rollback Procedures

### Visual Rollback
```bash
# List available backups
npm run snapshots list

# Restore specific backup
npm run snapshots restore snapshots-2025-07-30

# Verify restoration
npm run test:visual:all
```

### Git Rollback
```bash
# Checkout from production tag
git checkout prod-visual-lock-2025-07-30

# Create fix branch
git checkout -b fix/visual-regression

# Make fixes and test
npm run test:visual:all
```

### Production Rollback
1. Go to Vercel dashboard
2. Find last known good deployment
3. Click "Redeploy" or "Promote to Production"
4. Tag the rollback for reference

## 📝 Documentation Requirements

### Snapshot README
Each archive should include a README with:
- Date and commit reference
- Test results summary
- Visual changes made
- Performance metrics

### Commit Messages
For visual changes:
```
feat(visual): Update Hero typography spacing
- Adjusted line-height for better readability
- Updated snapshots for all breakpoints
- Tests: 25/25 passing
```

### PR Descriptions
Include:
- Visual changes summary
- Screenshot comparisons (if applicable)
- Test results
- Snapshot update confirmation

## ✅ Pre-Deployment Checklist

Before any deployment:

- [ ] All visual tests passing (`npm run test:visual:all`)
- [ ] Snapshots backed up (`npm run snapshots        # backup current snapshots`)
- [ ] Changes documented in commit/PR
- [ ] Production tag created (`prod-visual-lock-YYYY-MM-DD`)
- [ ] Archive created for milestone releases

## 🚨 Emergency Procedures

### Visual Test Failures
1. Check if changes are intentional
2. Review visual diffs in `test-results/`
3. If intentional: Update snapshots
4. If regression: Rollback changes

### Snapshot Corruption
1. Restore from backup: `npm run snapshots restore`
2. If no backup: Checkout from last tag
3. Regenerate snapshots
4. Create new backup immediately

### Production Visual Issues
1. **Immediate**: Rollback in Vercel
2. **Investigation**: Pull production tag locally
3. **Fix**: Create fix branch
4. **Test**: Full visual suite
5. **Deploy**: Tag and promote

## 🔧 Maintenance

### Weekly
- Clean old snapshot backups: `npm run snapshots clean`
- Validate current snapshots: `npm run snapshots validate`
- Review test execution times

### Monthly
- Archive milestone snapshots
- Update test thresholds if needed
- Review and update this documentation

## 📚 Related Documentation

- [Visual Integrity Plan](VISUAL_INTEGRITY.md)
- [Claude Best Practices](.claude/claude.md)
- [Testing Guide](tests/visual-integrity.md)
- [Deployment Strategy](docs/deployment-strategy.md)

---

**Last Updated**: 2025-07-30  
**Version**: 1.0.0  
**Next Review**: After next major release